<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/bootstrap-icons.css" />
    <link rel="stylesheet" href="../assets/css/app.css" />
    <link
      rel="stylesheet"
      href="../node_modules/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css"
    />
    <style>
      .form-row {
        display: flex;
        gap: 10px; /* 设置列间距 */
      }
      .form-row .form-control {
        flex: 1; /* 使输入框宽度可伸缩 */
      }
      a:hover {
        cursor: pointer;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <!-- 自定义标题栏 -->
    <div class="title-bar">
      <div class="title">商品信息采集</div>
      <div class="title-bar-buttons">
        <button id="minimize">_</button>
        <button id="maximize">
          <i id="maximize-icon" class="bi bi-arrows-angle-expand"></i>
        </button>
        <button id="close"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <!-- 公共部分 -->
    <div class="menu">
      <ul class="nav">
        <li class="nav-item">
          <a class="nav-link" href="./index.html">任务</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="./data.html">数据中心</a>
        </li>
      </ul>
    </div>
    <div class=".alert"></div>

    <div id="meilu-data" class=".container" style="padding: 15px">
      <!-- <button id="add_task_show" class="btn btn-primary">添加任务</button> -->

      <form>
        <div class="form-row">
          <!-- <input
            type="text"
            id="datepicker"
            class="form-control"
            placeholder="选择日期"
            style="max-width: 120px"
          /> -->
          <input
            type="text"
            id="merchant_id"
            class="form-control"
            placeholder="商家ID"
            style="max-width: 120px"
          />
          <input
            type="text"
            id="product_id"
            class="form-control"
            placeholder="商品ID"
            style="max-width: 120px"
          />

          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="checkbox"
              id="rating"
              value="1"
            />
            <label class="form-check-label" for="rating">有新增评论的</label>
          </div>

          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="checkbox"
              id="favorites"
              value="1"
            />
            <label class="form-check-label" for="favorites">有新增收藏的</label>
          </div>
          <a class="btn btn-primary" id="search">搜索</a>
          <a class="btn btn-warning" id="clearfrom">清空筛选</a>
          <button type="button" class="btn btn-dark" id="reload">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-arrow-repeat"
              viewBox="0 0 16 16"
            >
              <path
                d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
              ></path>
              <path
                fill-rule="evenodd"
                d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
              ></path>
            </svg>
          </button>
          <a class="btn btn-info" id="import">导出数据</a>
          <button class="btn btn-danger btn-sm" id="batchDelete">
            批量删除
          </button>
        </div>
      </form>

      <div>
        <table
          class="table table-sm table-striped"
          style="margin-top: 20px"
          id="data-table"
        >
          <thead>
            <tr>
              <th scope="col">
                <input type="checkbox" id="selectAll" />
              </th>
              <!-- <th scope="col">ID</th> -->
              <th scope="col">日期</th>
              <th scope="col">商家ID</th>
              <th scope="col">商品ID</th>
              <th scope="col">评价</th>
              <th scope="col">收藏</th>
              <th scope="col">新增评论</th>
              <th scope="col">新增收藏</th>
              <th scope="col">价格</th>
              <th scope="col">最新更新日期</th>
              <th scope="col">操作</th>
            </tr>
          </thead>
          <tbody id="task-table-body">
            <td colspan="10" style="text-align: center">暂无数据</td>
          </tbody>
        </table>
      </div>
    </div>

    <script src="../electron/renderer.js"></script>
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <script src="../node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
    <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="../electron/xlsx.full.min.js"></script>
    <script>
      document.getElementById('import').addEventListener('click', function () {
        const timestamp = Date.now()
        const xslxName = formatTimestamp(timestamp)
        // 获取表格
        const table = document.getElementById('data-table')

        // 使用 SheetJS 将表格数据转换为工作簿
        const wb = XLSX.utils.table_to_book(table, { sheet: 'Sheet1' })

        // 生成 Excel 文件并下载
        XLSX.writeFile(wb, `${xslxName}.xlsx`)
        // showAlert('导出完成')
      })

      // 日期控件
      $(document).ready(function () {
        $('#datepicker').datepicker({
          format: 'yyyy-mm-dd', // 自定义日期格式
          autoclose: true, // 选择日期后自动关闭
          todayHighlight: true // 高亮显示今天的日期
        })
      })
      // 刷新
      document.getElementById('reload').addEventListener('click', async () => {
        fetchData()
        showAlert('刷新成功')
      })

      // 搜索
      document.getElementById('search').addEventListener('click', async () => {
        fetchData()
      })
      document
        .getElementById('clearfrom')
        .addEventListener('click', async () => {
          // document.getElementById('datepicker').value = ''
          document.getElementById('merchant_id').value = ''
          document.getElementById('product_id').value = ''
          document.getElementById('rating').checked = false
          document.getElementById('favorites').checked = false
          fetchData()
        })

      async function fetchData() {
        // showAlert('重载数据中...')
        // const date = document.getElementById('datepicker').value
        let date = getDateOnly(new Date())
        const merchant_id = document.getElementById('merchant_id').value
        const product_id = document.getElementById('product_id').value
        const rating = document.getElementById('rating').checked
        const favorites = document.getElementById('favorites').checked

        try {
          // console.log(date)
          let params = []
          let query = `SELECT * FROM task_details WHERE 1=1`
          if (date) {
            query += ` AND days = ?`
            params.push(date)
          }
          if (merchant_id) {
            query += ` AND merchant_id = ?`
            params.push(merchant_id)
          }
          if (product_id) {
            query += ` AND product_id = ?`
            params.push(product_id)
          }
          if (rating) {
            query += ` AND rating_added > ?`
            params.push(0)
          }
          if (favorites) {
            query += ` AND favorites_added > ?`
            params.push(0)
          }
          query += ' ORDER BY days DESC, updated_at DESC'

          const frequencyMap = {
            1: '默认执行一次',
            2: '每半小时'
          }
          const result = await window.db.query(query, params)
          const tableBody = document.getElementById('task-table-body')
          tableBody.innerHTML = ''
          result.forEach((task) => {
            const row = document.createElement('tr')
            // <td>${task.id}</td>
            //
            row.innerHTML = `
                    <td><input type="checkbox" class="itemCheckbox" value="${task.id}" /></td>
                    <td>${task.days}</td>
                    <td style="user-select: text; cursor: pointer;" class="copay-merchant" data-url="https://jp.mercari.com/user/profile/${task.merchant_id}" >${task.merchant_id}</td>
                    <td style="user-select: text; cursor: pointer;" class="copay-product" data-url="https://jp.mercari.com/item/${task.product_id}">${task.product_id}</td>
                    <td>${task.rating}</td>
                    <td>${task.favorites}</td>
                    <td>${task.rating_added}</td>
                    <td>${task.favorites_added}</td>
                    <td>${task.price}</td>
                    <td>${task.updated_at}</td>
                    <td><a class='delete-btn' style='color:#dc3545;min-width:40px' data-id="${task.id}">删除</a></td>
                  `
            // <button class="btn btn-danger btn-sm delete-btn" style="min-width:50px;" data-id="${task.id}">删除</button>
            tableBody.appendChild(row)
          })
          document.querySelectorAll('.delete-btn').forEach((btn) => {
            btn.addEventListener('click', handleDelete)
          })

          document.querySelectorAll('.copay-product').forEach((btn) => {
            btn.addEventListener('dblclick', copyProductUrl)
          })

          document.querySelectorAll('.copay-merchant').forEach((btn) => {
            btn.addEventListener('dblclick', copyProductUrl)
          })
        } catch (error) {
          console.error('Failed to fetch data:', error)
        }
      }

      async function handleDelete(event) {
        const taskId = event.target.getAttribute('data-id')
        if (confirm('确定要删除这条数据吗？')) {
          try {
            await window.db.delete('DELETE FROM task_details WHERE id = ?', [
              taskId
            ])
            fetchData() // 重新加载数据
          } catch (error) {
            console.error('Failed to delete task:', error)
          }
        }
      }

      document
        .getElementById('selectAll')
        .addEventListener('change', function () {
          // 获取全选框的状态
          const isChecked = this.checked

          // 获取所有的行复选框
          const checkboxes = document.querySelectorAll(
            '#task-table-body .itemCheckbox'
          )

          // 设置所有复选框的状态
          checkboxes.forEach((checkbox) => {
            checkbox.checked = isChecked
          })
        })

      // 批量删除

      document
        .getElementById('batchDelete')
        .addEventListener('click', async () => {
          // 获取所有选中的复选框
          const selectedCheckboxes = document.querySelectorAll(
            '#task-table-body .itemCheckbox:checked'
          )

          // 提取选中项的 ID
          const selectedIds = Array.from(selectedCheckboxes).map(
            (checkbox) => checkbox.value
          )

          if (selectedIds.length === 0) {
            alert('请选择要删除的记录')
            return
          }

          console.log(selectedIds)
          if (confirm('确定要删除这些数据吗？')) {
            try {
              // 构建 SQL 查询
              const placeholders = selectedIds.map(() => '?').join(', ')
              await window.db.delete(
                `DELETE FROM task_details WHERE id in (${placeholders})`,
                selectedIds
              )
              fetchData() // 重新加载数据
            } catch (error) {
              console.error('Failed to delete task:', error)
            }
          }
          console.log(selectedIds)
        })

      function getDateOnly(timestamp) {
        const date = new Date(timestamp)
        const year = date.getFullYear()
        const month = String(date.getMonth() + 1).padStart(2, '0')
        const day = String(date.getDate()).padStart(2, '0')

        return `${year}-${month}-${day}`
      }

      async function copyProductUrl(event) {
        const productUrl = event.target.getAttribute('data-url')
        try {
          await navigator.clipboard.writeText(productUrl)
          showAlert('复制成功')
        } catch (error) {
          console.error('Failed to copy product URL:', error)
          fallbackCopyTextToClipboard(productUrl)
        }
      }

      function fallbackCopyTextToClipboard(text) {
        const textarea = document.createElement('textarea')
        textarea.value = text
        document.body.appendChild(textarea)
        textarea.select()
        document.execCommand('copy')
        document.body.removeChild(textarea)
        showAlert('复制成功')
      }

      function showAlert(message) {
        const alertDiv = document.createElement('div')
        alertDiv.classList.add('alert')
        alertDiv.textContent = message
        document.body.appendChild(alertDiv)

        setTimeout(() => {
          alertDiv.classList.add('hidden')
          setTimeout(() => {
            document.body.removeChild(alertDiv)
          }, 1000) // 确保动画完成后再移除元素
        }, 1000) // 1秒后开始淡出
      }
    </script>
  </body>
</html>
